package com.lex.photowall;

import java.util.HashSet;
import java.util.Set;

import android.content.Context;
import android.graphics.Bitmap;
import android.os.AsyncTask;
import android.os.Handler;
import android.os.Message;
import android.util.AttributeSet;
import android.view.MotionEvent;
import android.view.View;
import android.view.View.OnTouchListener;
import android.widget.LinearLayout;
import android.widget.ScrollView;

public class MyScrollView extends ScrollView implements OnTouchListener {
	/**
	 * 每页要加载的图片的数量
	 */
	public static final int PAGE_SIZE = 15;
	/**
	 * 记录当前加载到第几页
	 */
	private int page;
	/**
	 * 每一列的宽度
	 */
	private int columnWidth;
	private int firstColumnWidth;
	private int secondColumnWidth;
	private int thirdColumnWidth;
	/**
	 * 是否已经加载过Layout，这里的Layout初始化只需加载一次
	 */
	private boolean loadOnce;
	private ImageLoader imageLoader;

	private LinearLayout firstColumn;
	private LinearLayout secondColumn;
	private LinearLayout thirdColumn;

	private static Set<LoadImageTask> taskCollection;
	/**
	 * MyScrollView下的直接子布局。
	 */
	private static View scrollLayout;

	/**
	 * MyScrollView布局的高度。
	 */
	private static int scrollViewHeight;

	private static int lastScrollY = -1;

	private Handler handler = new Handler() {
		public void handleMessage(Message msg) {
			MyScrollView myScrollView = (MyScrollView) msg.obj;
			int scrollY = myScrollView.getScrollY();
			if (scrollY == lastScrollY) {
				if (scrollViewHeight + scrollY >= scrollLayout.getHeight() 
						&& taskCollection.isEmpty()) {
					myScrollView.loadMoreImage();
				}
				myScrollView.checkVisibility();
			}else {
				lastScrollY = scrollY;
				Message message = new Message();
				message.obj = myScrollView;
				handler.sendMessageDelayed(message, 5);
			}
		};
	};

	public MyScrollView(Context context, AttributeSet attrs) {
		super(context, attrs);
		imageLoader = ImageLoader.getInstance();
		taskCollection = new HashSet<LoadImageTask>();
		setOnTouchListener(this);
	}

	@Override
	public boolean onTouch(View v, MotionEvent event) {
		if (event.getAction() == MotionEvent.ACTION_UP) {
			Message msg = new Message();
			msg.obj = this;
			handler.sendMessageDelayed(msg, 5);
		}
		return false;
	}
	
	private void checkVisibility() {
		
	}

	private void loadMoreImage() {

	}

	class LoadImageTask extends AsyncTask<String, Void, Bitmap> {

		@Override
		protected Bitmap doInBackground(String... params) {
			return null;
		}

	}
}
